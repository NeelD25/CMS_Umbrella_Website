<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Complete Advanced Post Editor (Fixed Tables/Resizing)</title>
<style>
/* ------------------------------------------------------------- */
/* 1. ROOT VARIABLES & GENERAL STYLES */
/* ------------------------------------------------------------- */
:root{
    --primary-accent: #007bff; /* Default Primary Accent Color (Blue) */
    --secondary-accent: #2c3e50; /* Default Secondary Accent Color (Dark Grey) */
    --light:#f8f9fa; /* Light Gray Background */
    --panel:#fff; /* Editor Panel Background */
    --muted:#6c757d;
    --danger:#dc3545; /* Red for Delete/Apply CTA */
    --success:#28a745;
    --info:#17a2b8;
}
/* NEW: Full Screen Utilization */
body{
    font-family:Arial, sans-serif; 
    background:var(--light);
    margin:0; /* Remove default margin */
    padding:0;
    color:#222;
    line-height:1.7; 
}
.page{
    max-width:1400px; /* Increased max-width */
    width: 95%; /* Use full width if available */
    margin:20px auto;
    background:var(--panel);
    padding:28px;
    border-radius:10px;
    box-shadow:0 6px 18px rgba(0,0,0,.08);
    box-sizing: border-box;
}

/* ------------------------------------------------------------- */
/* 2. EDITOR FORM ELEMENT STYLES */
/* ------------------------------------------------------------- */
input[type="text"],input[type="url"],input[type="number"]{width:100%;padding:10px;border:1px solid #d7d7d7;border-radius:6px;box-sizing:border-box;font-size:14px}
.toolbar input[type="color"], 
#actionButtonsContainer input[type="color"], 
.text-link-container input[type="color"],
.color-group input[type="color"] {
    width: 30px;
    height: 30px;
    padding: 0;
    border: 1px solid #ddd;
    border-radius: 4px;
    vertical-align: middle;
    cursor: pointer;
}
textarea{min-height:80px;resize:vertical;width:100%;padding:10px;border:1px solid #d7d7d7;border-radius:6px;box-sizing:border-box;font-size:14px;font-family:inherit}
.rich-editor{min-height:150px;border:1px solid #d7d7d7;border-radius:6px;padding:12px;background:#fff;max-height:500px;overflow-y:auto;line-height:1.8}
.rich-editor:focus{outline:2px solid var(--primary-accent);outline-offset:2px}
.rich-editor:empty:before{content:attr(data-placeholder);color:#999}

/* Rich Text H1, H2, H3 styles (matches preview structure) */
.rich-editor ul,.rich-editor ol{margin:10px 0;padding-left:30px;list-style-position:outside}
.rich-editor ul{list-style-type:disc}
.rich-editor ol{list-style-type:decimal}
.rich-editor li{margin:6px 0;padding-left:5px}
.rich-editor p{margin:10px 0; font-size: 16px;}
.rich-editor h1{font-size:32px;margin:20px 0 14px 0;font-weight:700;color:#1a1a1a}
.rich-editor h2{font-size:26px;margin:18px 0 10px 0;font-weight:600;color: var(--primary-accent);}
.rich-editor h3{font-size:22px;margin:16px 0 8px 0;font-weight:600;color: var(--secondary-accent);}
.rich-editor h4{font-size:18px;margin:14px 0 6px 0;font-weight:600;color: #333;}
.rich-editor strong,.rich-editor b{font-weight:700}
.toolbar{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;padding:10px;background:#f8f9fa;border-radius:6px;border:1px solid #e0e0e0; align-items: center;}
.toolbar button{padding:7px 12px;border:1px solid #ddd;background:#fff;border-radius:4px;cursor:pointer;font-size:13px;transition:all 0.2s}
.toolbar button:hover{background:#e9ecef;border-color:#aaa}
.toolbar button.active{background:var(--primary-accent);color:#fff;border-color:var(--primary-accent)}
.toolbar-separator{width:1px;background:#ddd;margin:0 4px}

/* --- FIX #4 & NEW FEATURE: STYLING FOR PASTED TABLES --- */
/* Base table styles for rich-editor (pasted tables) */
.rich-editor table{
    width:auto; /* Start with auto width */
    border-collapse:collapse;
    margin-top:10px;
    border:1px solid #e0e0e0;
    max-width: 100%; /* Ensure it doesn't overflow the editor */
}
.rich-editor th, .rich-editor td{
    border:1px solid #e0e0e0;
    padding:8px 10px;
    text-align:left;
    vertical-align:middle;
}
.rich-editor th{
    background:#e3f2fd;
    font-weight:600;
    color:#0d47a1;
}

/* Alignment logic for pasted tables (using old school HTML alignment attributes) */
/* The execCommand for justification only works on block elements (like P, DIV, TABLE in some browsers) */
/* We use margin auto/0 to handle the alignment based on the 'align' attribute */
.rich-editor table[align="center"] {
    margin-left: auto;
    margin-right: auto;
}
.rich-editor table[align="right"] {
    margin-left: auto;
    margin-right: 0;
}
.rich-editor table[align="left"] {
    margin-left: 0;
    margin-right: auto;
}

/* Toolbar Controls for Table Sizing/Position */
.table-size-controls {
    display: flex;
    gap: 8px;
    align-items: center;
    padding: 0 5px;
}
.table-size-controls label {
    font-size: 13px;
    font-weight: 600;
    color: var(--muted);
}
.table-size-controls button {
    padding: 4px 8px;
    font-size: 12px;
}
.table-size-controls input[type="number"] {
    width: 60px;
    padding: 5px;
    border: 1px solid #ddd;
    border-radius: 4px;
}
/* ------------------------------------------- */

h3.section-title{
    color:var(--primary-accent);
    margin:0; 
    display:block;
    font-size:19px;
    font-weight:600;
    padding-right: 140px;
    border-bottom: none; 
}

.section{border:1px solid #e6e6e6;padding:18px;border-radius:8px;margin-bottom:18px;position:relative;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.03)}
.section-controls{position:absolute;right:12px;top:12px;display:flex;gap:4px;z-index:3}
.btn{cursor:pointer;border:0;padding:7px 10px;border-radius:6px;font-size:13px;color:#fff;transition:all 0.2s}
.btn.updown{background:#8a8f96;padding: 7px 8px; font-size: 11px;}
.btn.edit{background:#007bff; padding: 7px 8px; font-size: 11px;}
.btn.delete{background:var(--danger); padding: 7px 8px; font-size: 11px;}
.btn.add{background:var(--success)}
.btn.remove{background:#ff6b6b}
/* This CSS applies to the dedicated Custom Table section's editor, not pasted tables */
table{width:100%;border-collapse:collapse;margin-top:10px} 
th,td{border:1px solid #e0e0e0;padding:10px;text-align:left;vertical-align:middle}
th{background:#e3f2fd;font-weight:600;color:#0d47a1}
.add-section-bar{margin-bottom:20px;padding:16px;background:linear-gradient(135deg,var(--primary-accent) 0%,#0056b3 100%); 
    border-radius:8px;display:flex;gap:10px;flex-wrap:wrap;box-shadow:0 4px 6px rgba(0,0,0,.1);position:relative}
.add-section-bar .btn{background:rgba(255,255,255,0.95);color:var(--primary-accent);font-weight:600}
.table-config{display:flex;gap:12px;margin-bottom:12px;align-items:center;padding:10px;background:#f8f9fa;border-radius:6px}
.table-config label{font-size:13px;font-weight:600}
.table-config input{width:80px;padding:6px}

/* Button & Link Rows FIX - Restore Horizontal Layout */
#actionButtonsContainer > div, 
[id^="noHeadingButtonsContainer"] > div,
.text-link-container > div {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
    align-items: center;
    border: 1px solid #ddd;
    padding: 8px;
    border-radius: 6px;
}
.btn-controls {
    display: flex;
    gap: 4px;
}
.btn-controls .btn {
    padding: 3px 6px;
    font-size: 11px;
    line-height: 1;
}

/* ------------------------------------------------------------- */
/* 3. PREVIEW AREA STYLES */
/* ------------------------------------------------------------- */
.preview-area{max-width: none; margin: 0; padding: 0; background-color: var(--light); box-shadow: none;}
.preview-area .post-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    background-color: #ffffff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
.preview-area .post-header-box {
    text-align: center;
    margin-top: 30px; 
    margin-bottom: 30px;
    padding: 20px;
    background-color: var(--primary-accent); 
    color: white;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.preview-area h2 {
    color: var(--primary-accent); 
    border-bottom: 3px solid var(--primary-accent);
    padding-bottom: 10px;
    margin-top: 40px;
    margin-bottom: 16px;
    font-size: 26px;
    font-weight: 600;
}
.preview-area table{width:100%;border-collapse:collapse;margin:15px 0}
.preview-area th, .preview-area td{border:1px solid #ddd;padding:12px;text-align:left;vertical-align:middle}
.preview-area th{
    background:#e9f5ff; 
    font-weight:700;
    color:var(--primary-accent);
    border-top: 3px solid var(--primary-accent); 
}

/* Footer Style for Preview */
.preview-area footer {
    width: 100%;
    text-align: center;
    padding: 15px 10px;
    background-color: #2c3e50;
    color: #ffffff;
    font-size: 14px;
    max-width: 1200px; 
    margin: 0 auto; 
    border-top-left-radius: 8px; 
    border-top-right-radius: 8px;
    box-sizing: border-box;
}

/* Clone Dropdown (Restored) */
#cloneDropdown {
    position: absolute;
    top: 35px;
    right: 12px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    z-index: 10;
    padding: 5px 0;
}
#cloneDropdown button {
    display: block;
    width: 100%;
    text-align: left;
    padding: 8px 15px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 13px;
    color: #333;
    transition: background-color 0.2s;
}
#cloneDropdown button:hover {
    background-color: #f0f0f0;
}
</style>
</head>
<body>

<header id="mainHeader" style="background-color:#007bff; padding:12px 20px; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; box-shadow: 0 0 8px rgba(0,0,0,0.1); max-width: 1400px; margin: 0 auto;">
  <a href="https://rozgardesk.in/" style="color:white; text-decoration:none; font-size:22px; font-weight:700;">
    RozgarDesk.in EDITOR
  </a>
  <nav style="display:flex; gap:15px;">
    <a href="https://rozgardesk.in/" style="color:white; text-decoration:none; font-size:16px;">Home</a>
  </nav>
</header>
<div class="page">
<h1 class="title">📝 Complete Advanced Post Editor</h1>

<div id="customizationPanel" style="display: flex; gap: 20px; margin-bottom: 20px; align-items: center; border: 1px solid #e6e6e6; padding: 15px; border-radius: 8px; background: #fff;">
    <label style="font-weight: 700;">Theme Colors:</label>
    <div class="color-group" style="display:flex; gap:8px; align-items:center;">
        <label for="primaryColorPicker" style="font-size:14px;">Primary (H2/Borders):</label>
        <input type="color" id="primaryColorPicker" value="#007bff" onchange="updateCustomColors()">
    </div>
    <div class="color-group" style="display:flex; gap:8px; align-items:center;">
        <label for="secondaryColorPicker" style="font-size:14px;">Secondary (H3):</label>
        <input type="color" id="secondaryColorPicker" value="#2c3e50" onchange="updateCustomColors()">
    </div>
</div>
<div style="margin-bottom:16px">
<input id="postTitle" type="text" placeholder="Enter Post Title (Job/Blog/Article)"/>
</div>

<div class="add-section-bar" id="addSectionBar">
<button class="btn" onclick="addRichTextSection()">📄 Rich Text</button>
<button class="btn" onclick="addCustomTable()">📊 Custom Table</button>
<button class="btn" onclick="addImageSection()">🖼️ Image</button>
<button class="btn" onclick="addSimpleTextSection()">📝 Simple Text</button>
<button class="btn" onclick="addActionButtonSection()">🎯 Action Buttons (With Heading)</button>
<button class="btn" onclick="addNoHeadingButtonsSection()">🎯 Action Buttons (No Heading)</button>
<button class="btn" onclick="addTextLinkSection()">🔗 Text Links</button>
</div>

<div id="sectionsContainer">

<div class="section" id="sec_details" data-default-title="Notification Details" data-type="richtext">
    <div class="section-controls">
        <button class="btn updown" onclick="moveSection(this,'up')">↑</button>
        <button class="btn updown" onclick="moveSection(this,'down')">↓</button>
        <button class="btn edit" onclick="editTitle(this)">✏️</button>
        <button class="btn" onclick="cloneSectionDialog(this)">➕</button>
        <button class="btn delete" onclick="deleteSection(this)">🗑️</button>
    </div>
<h3 class="section-title">Notification Details</h3>
<div class="toolbar">
<select onchange="formatDoc('formatBlock', this.value, this)" title="Heading/Text Size">
    <option value="<p>">Normal Text</option>
    <option value="<h1>">Heading 1 (Largest)</option>
    <option value="<h2>">Heading 2</option>
    <option value="<h3>">Heading 3</option>
    <option value="####">Heading 4</option>
</select>
<button onmousedown="event.preventDefault(); formatDoc('bold', null, this)"><b>B</b></button>
<button onmousedown="event.preventDefault(); formatDoc('italic', null, this)"><i>I</i></I></button>
<button onmousedown="event.preventDefault(); formatDoc('underline', null, this)"><u>U</u></button>
<span class="toolbar-separator"></span>
<button onmousedown="event.preventDefault(); formatDoc('insertUnorderedList', null, this)">• List</button>
<button onmousedown="event.preventDefault(); formatDoc('insertOrderedList', null, this)">1. List</button>
<span class="toolbar-separator"></span>
<button onmousedown="event.preventDefault(); formatDoc('justifyLeft', null, this)">Left</button>
<button onmousedown="event.preventDefault(); formatDoc('justifyCenter', null, this)">Center</button>
<button onmousedown="event.preventDefault(); formatDoc('justifyRight', null, this)">Right</button>
<span class="toolbar-separator"></span>
<label for="color_picker_TEXT_default" style="font-size:13px;">Text:</label>
<input type="color" id="color_picker_TEXT_default" onchange="formatDoc('foreColor', this.value, this)" title="Text Color" value="#333333">

<label for="color_picker_HIGHLIGHT_default" style="font-size:13px;">Highlight:</label>
<input type="color" id="color_picker_HIGHLIGHT_default" onchange="formatDoc('backColor', this.value, this)" title="Text Highlight" value="#ffff00">
<span class="toolbar-separator"></span>

<div class="table-size-controls">
    <label title="Set table width in percentage (applies to selected table)">Table Width (%):</label>
    <input type="number" id="tableWidthInput_default" min="20" max="100" value="100" title="Set table width" 
           onchange="setTableWidth(this.value, this)">
</div>
<button onmousedown="event.preventDefault(); formatDoc('removeFormat', null, this)">Clear</button>
</div>
<div class="rich-editor sec-content" contenteditable="true" data-placeholder="Enter main notification details or introduction..."></div>
</div>

<div class="section" id="sec_dates" data-default-title="Important Dates" data-type="table">
    <div class="section-controls">
        <button class="btn updown" onclick="moveSection(this,'up')">↑</button>
        <button class="btn updown" onclick="moveSection(this,'down')">↓</button>
        <button class="btn edit" onclick="editTitle(this)">✏️</button>
        <button class="btn" onclick="cloneSectionDialog(this)">➕</button>
        <button class="btn delete" onclick="deleteSection(this)">🗑️</button>
    </div>
<h3 class="section-title">Important Dates</h3>
<div class="table-config">
    <label for="colCount_default_table">Columns:</label>
    <input type="number" id="colCount_default_table" value="2" min="1" max="10" onchange="createTableFromConfig(this)">
</div>
<table><thead><tr><th><input type="text" value="Event"></th><th><input type="text" value="Date"></th><th style="width:90px">Action</th></tr></thead>
<tbody>
<tr>
<td><input type="text" placeholder="Event"></td>
<td><input type="text" placeholder="Date"></td>
<td><button class="btn add" onclick="addRow(this)">+</button></td>
</tr>
</tbody>
</table>
</div>

<div class="section" id="sec_buttons" data-default-title="Action Buttons" data-type="buttons">
    <div class="section-controls">
        <button class="btn updown" onclick="moveSection(this,'up')">↑</button>
        <button class="btn updown" onclick="moveSection(this,'down')">↓</button>
        <button class="btn edit" onclick="editTitle(this)">✏️</button>
        <button class="btn" onclick="cloneSectionDialog(this)">➕</button>
        <button class="btn delete" onclick="deleteSection(this)">🗑️</button>
    </div>
<h3 class="section-title">Action Buttons</h3>
<div id="actionButtonsContainer"></div>
<div style="margin-top:8px">
<button class="btn add" onclick="addActionButton('Apply Now', '#', 'actionButtonsContainer')">+ Add Button</button>
</div>
<div class="small">Buttons with custom labels, links, and colors (Renders with H2 heading).</div>
</div>
</div>

<div class="restore-area">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<strong>♻️ Restore Deleted</strong>
<span class="small">Deleted sections here</span>
</div>
<div class="restore-list" id="restoreList"></div>
</div>

<div class="footer-actions" style="margin-top:20px; display:flex; gap:10px;">
<button class="btn edit" style="background:#0b5ed7" onclick="previewPost()">👁️ Preview</button>
<button class="btn" style="background:#28a745" onclick="downloadHTML()">⬇️ Download HTML</button>
<button class="btn gray" style="background:#6c757d" onclick="location.reload()">🔄 Reset</button>
</div>
<div id="preview" class="preview-area hidden" style="margin-top:20px;"></div>
</div>

<script>
// --- GLOBAL TEMPLATES & CONSTANTS ---
const universalControlsHTML = (hasClone = true) => {
    let html = `
    <div class="section-controls">
        <button class="btn updown" onclick="moveSection(this,'up')">↑</button>
        <button class="btn updown" onclick="moveSection(this,'down')">↓</button>
        <button class="btn edit" onclick="editTitle(this)">✏️</button>`;
    if (hasClone) {
        html += `<button class="btn" onclick="cloneSectionDialog(this)">➕</button>`;
    }
    html += `<button class="btn delete" onclick="deleteSection(this)">🗑️</button>
    </div>`;
    return html;
};

// Rich Text Toolbar HTML
const richTextToolbarHTML = (sectionId) => `
    <div class="toolbar">
        <select onchange="formatDoc('formatBlock', this.value, this)" title="Heading/Text Size">
            <option value="<p>">Normal Text</option>
            <option value="<h1>">Heading 1 (Largest)</option>
            <option value="<h2>">Heading 2</option>
            <option value="<h3>">Heading 3</option>
            <option value="<h4>">Heading 4</option>
        </select>
        <button onmousedown="event.preventDefault(); formatDoc('bold', null, this)"><b>B</b></button>
        <button onmousedown="event.preventDefault(); formatDoc('italic', null, this)"><i>I</i></I></button>
        <button onmousedown="event.preventDefault(); formatDoc('underline', null, this)"><u>U</u></button>
        <span class="toolbar-separator"></span>
        <button onmousedown="event.preventDefault(); formatDoc('insertUnorderedList', null, this)">• List</button>
        <button onmousedown="event.preventDefault(); formatDoc('insertOrderedList', null, this)">1. List</button>
        <span class="toolbar-separator"></span>
        <button onmousedown="event.preventDefault(); formatDoc('justifyLeft', null, this)">Left</button>
        <button onmousedown="event.preventDefault(); formatDoc('justifyCenter', null, this)">Center</button>
        <button onmousedown="event.preventDefault(); formatDoc('justifyRight', null, this)">Right</button>
        <span class="toolbar-separator"></span>
        <label for="color_picker_TEXT_${sectionId}" style="font-size:13px;">Text:</label>
        <input type="color" id="color_picker_TEXT_${sectionId}" onchange="formatDoc('foreColor', this.value, this)" title="Text Color" value="#333333">
        
        <label for="color_picker_HIGHLIGHT_${sectionId}" style="font-size:13px;">Highlight:</label>
        <input type="color" id="color_picker_HIGHLIGHT_${sectionId}" onchange="formatDoc('backColor', this.value, this)" title="Text Highlight" value="#ffff00">
        
        <span class="toolbar-separator"></span>
        
        <div class="table-size-controls">
            <label title="Set table width in percentage (applies to selected table)">Width (%):</label>
            <input type="number" id="tableWidthInput_${sectionId}" min="20" max="100" value="100" title="Set table width" 
                   onchange="setTableWidth(this.value, this)">
        </div>
        <button onmousedown="event.preventDefault(); formatDoc('removeFormat', null, this)">Clear</button>
    </div>
`;

// Universal Top Header HTML
const UNIVERSAL_TOP_HEADER = (primaryColor) => {
    return `
<header class="preview-header-blue" style="
    background-color:${primaryColor}; 
    max-width: 1200px;
    margin: 0 auto;
    padding:12px 20px; 
    display:flex; 
    align-items:center; 
    justify-content:space-between; 
    flex-wrap:wrap; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-bottom-left-radius: 8px;
    border-bottom-right-radius: 8px;
    ">
    <a href="https://rozgardesk.in/" style="color:white; text-decoration:none; font-size:22px; font-weight:700;">
        RozgarDesk.in
    </a>
    <nav style="display:flex; gap:15px;">
        <a href="https://rozgardesk.in/" style="color:white; text-decoration:none; font-size:16px;">Home</a>
    </nav>
</header>`;
};


// Universal Footer HTML
const UNIVERSAL_FOOTER = `
<footer style="
    all: initial;
    display: block;
    width: 100%;
    text-align: center;
    padding: 15px 10px;
    background-color: #2c3e50;
    color: #ffffff;
    font-family: Arial, Helvetica, sans-serif;
    font-size: 14px;
    box-sizing: border-box;
    max-width: 1200px; 
    margin: 0 auto; 
    border-top-left-radius: 8px; 
    border-top-right-radius: 8px;
">
    <p style="all: unset; display: inline; color: #ffffff;">
        &copy; ${new Date().getFullYear()} <strong>Rozgardesk</strong>. All rights reserved. 
        <a href='../privacypolicy.html' 
            style='all: unset; color:#ffffff; cursor:pointer; text-decoration:none; font-weight:500;'
            onmouseover='this.style.textDecoration="underline";'
            onmouseout='this.style.textDecoration="none";'>
            Privacy Policy
        </a> |
        <a href='../aboutus.html'
            style='all: unset; color:#ffffff; cursor:pointer; text-decoration:none; font-weight:500;'
            onmouseover='this.style.textDecoration="underline";'
            onmouseout='this.style.textDecoration="none";'>
            About Us
            </a> |

    <a href='../terms_and_conditions.html' style='all: unset; color:#ffffff; cursor:pointer; text-decoration:none; font-weight:500;' onmouseover='this.style.textDecoration="underline";' onmouseout='this.style.textDecoration="none";'>
      Terms and Conditions

        </a> |

    <a href='https://forms.gle/KzEzY3eSsJYxnxgXA' style='all: unset; color:#ffffff; cursor:pointer; text-decoration:none; font-weight:500;' onmouseover='this.style.textDecoration="underline";' onmouseout='this.style.textDecoration="none";'>
    Contact Us
        </a>
    </p>
</footer>
`;

// --- CUSTOM COLOR CONTROL ---
function updateCustomColors() {
    const primaryColor = document.getElementById('primaryColorPicker').value;
    const secondaryColor = document.getElementById('secondaryColorPicker').value;
    
    document.documentElement.style.setProperty('--primary-accent', primaryColor);
    document.documentElement.style.setProperty('--secondary-accent', secondaryColor);

    document.getElementById('mainHeader').style.backgroundColor = primaryColor;
    document.querySelector('.add-section-bar').style.background = `linear-gradient(135deg, ${primaryColor} 0%, #0056b3 100%)`;
    
    document.querySelectorAll('.section-title').forEach(h3 => {
        h3.style.color = primaryColor;
    });
}

// --- CORE FUNCTIONALITY ---
function formatDoc(command, value, element) {
    const editor = element.closest('.section').querySelector('.rich-editor');
    editor.focus();

    try {
        const commandValue = (command === 'formatBlock' && value === '<p>') ? 'p' : value;
        
        // Custom logic to handle table alignment since execCommand is unreliable on TABLE elements
        if (command.startsWith('justify')) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                let node = selection.getRangeAt(0).startContainer;
                // Traverse up to find a table element
                let table = null;
                while (node) {
                    if (node.tagName === 'TABLE') {
                        table = node;
                        break;
                    }
                    node = node.parentElement;
                }
                
                if (table) {
                    event.preventDefault(); // Stop default execCommand behavior
                    if (command === 'justifyCenter') {
                        table.setAttribute('align', 'center');
                    } else if (command === 'justifyRight') {
                        table.setAttribute('align', 'right');
                    } else { // justifyLeft
                        table.setAttribute('align', 'left');
                    }
                    return; // Stop further execution
                }
            }
        }
        
        // Default execCommand handling
        if (command === 'formatBlock') {
            document.execCommand('formatBlock', false, commandValue.replace(/[<>]/g, '')); 
        } else {
            document.execCommand(command, false, commandValue);
        }

    } catch (e) {
        console.error("Error executing execCommand:", e);
    }
    updateToolbarState(editor);
}

// NEW FUNCTION: Set Table Width
function setTableWidth(widthValue, inputElement) {
    const editor = inputElement.closest('.section').querySelector('.rich-editor');
    const numericWidth = parseInt(widthValue);
    
    if (isNaN(numericWidth) || numericWidth < 20 || numericWidth > 100) {
        console.warn("Invalid width value for table.");
        return;
    }

    const selection = window.getSelection();
    if (selection.rangeCount > 0) {
        let node = selection.getRangeAt(0).startContainer;
        let table = null;
        while (node) {
            if (node.tagName === 'TABLE') {
                table = node;
                break;
            }
            node = node.parentElement;
        }

        if (table) {
            table.style.width = numericWidth + '%';
            table.style.maxWidth = '100%'; 
            // Also update the align attribute to ensure correct centering/right align with new width
            if (!table.hasAttribute('align') || table.getAttribute('align') === '') {
                 table.setAttribute('align', 'left'); 
            }
        } else {
            console.log("No table selected.");
        }
    }
}


function updateToolbarState(editor){
    const toolbar = editor.previousElementSibling;
    if(!toolbar || !toolbar.classList.contains('toolbar')) return;
    
    // Update button states
    toolbar.querySelectorAll('button').forEach(button => {
        button.classList.remove('active');
        const commandText = button.getAttribute('onmousedown');
        if (commandText) {
            if (commandText.includes("('bold'") && document.queryCommandState('bold')) {
                button.classList.add('active');
            } else if (commandText.includes("('italic'") && document.queryCommandState('italic')) {
                button.classList.add('active');
            } else if (commandText.includes("('underline'") && document.queryCommandState('underline')) {
                button.classList.add('active');
            } else if (commandText.includes("('justifyLeft'") && document.queryCommandState('justifyLeft')) {
                button.classList.add('active');
            } else if (commandText.includes("('justifyCenter'") && document.queryCommandState('justifyCenter')) {
                button.classList.add('active');
            } else if (commandText.includes("('justifyRight'") && document.queryCommandState('justifyRight')) {
                button.classList.add('active');
            }
        }
    });
    
    // Update Table Width Input (New feature)
    const tableWidthInput = toolbar.querySelector('[id^="tableWidthInput_"]');
    if (tableWidthInput) {
        const selection = window.getSelection();
        let currentTable = null;
        if (selection.rangeCount > 0) {
            let node = selection.getRangeAt(0).startContainer;
            while (node) {
                if (node.tagName === 'TABLE') {
                    currentTable = node;
                    break;
                }
                node = node.parentElement;
            }
        }

        if (currentTable && currentTable.style.width) {
            const widthValue = parseInt(currentTable.style.width.replace('%', ''));
            tableWidthInput.value = widthValue || 100;
        } else {
            tableWidthInput.value = 100; // Reset to default if no table is selected
        }
    }
}

function moveSection(b,d){
    const s=b.closest('.section'),c=document.getElementById('sectionsContainer');
    if(d==='up'&&s.previousElementSibling)c.insertBefore(s,s.previousElementSibling);
    else if(d==='down'&&s.nextElementSibling)c.insertBefore(s.nextElementSibling,s)
}

function editTitle(b){
    const s=b.closest('.section'),h=s.querySelector('.section-title');
    const currentTitle = h.innerText;
    const i=document.createElement('input');
    i.type='text';
    i.value=currentTitle;
    i.style.width='70%';
    i.style.fontSize='18px';
    i.style.padding='5px';
    i.style.margin='0';
    h.innerText=''; 
    h.appendChild(i); 
    const saveTitle = () => {
        const newTitle = i.value.trim() || s.dataset.defaultTitle || 'Section';
        h.innerText = newTitle;
        s.setAttribute('data-default-title', newTitle);
        h.style.color = getComputedStyle(document.documentElement).getPropertyValue('--primary-accent');
        i.removeEventListener('blur', saveTitle);
        i.removeEventListener('keypress', handleKeyPress);
    };
    const handleKeyPress = (e) => {
        if(e.key==='Enter') i.blur(); 
    };
    i.addEventListener('blur', saveTitle);
    i.addEventListener('keypress', handleKeyPress);
    i.focus();
    i.select();
}

let deletedStore=[];
function deleteSection(b){
    const s=b.closest('.section'),id=s.id||('sec_'+Date.now());s.id=id;
    const cl=s.cloneNode(true); 
    
    // Manually capture dynamic content
    s.querySelectorAll('.rich-editor').forEach((sr,i)=>{
        if(cl.querySelectorAll('.rich-editor')[i]) cl.querySelectorAll('.rich-editor')[i].innerHTML = sr.innerHTML;
    });
    s.querySelectorAll('input,textarea').forEach((sr,i)=>{
        if(cl.querySelectorAll('input,textarea')[i] && sr.type !== 'button') { 
            cl.querySelectorAll('input,textarea')[i].value = sr.value;
        }
    });

    s.querySelectorAll('#actionButtonsContainer, .text-link-container, [id^="noHeadingButtonsContainer"]').forEach((sr, i) => {
        const targetContainer = cl.querySelector(`#${sr.id}`);
        if (targetContainer) {
            targetContainer.innerHTML = sr.innerHTML;
        }
    });

    const ti=s.querySelector('.section-title')?.innerText||s.dataset.defaultTitle||'Section';
    deletedStore.push({id,html:cl.outerHTML,title:ti});
    s.remove();
    refreshRestoreUI();
}
function refreshRestoreUI(){
    const l=document.getElementById('restoreList');l.innerHTML='';
    deletedStore.forEach(i=>{
        const d=document.createElement('div');d.classList.add('restore-item');
        d.innerHTML=`<span>${i.title}</span><button class="btn success" onclick="restoreSection('${i.id}')">Restore</button>`;
        l.appendChild(d);
    });
}
function restoreSection(id){
    const i=deletedStore.findIndex(item=>item.id===id);
    if(i>-1){
        const item=deletedStore.splice(i,1)[0];
        document.getElementById('sectionsContainer').insertAdjacentHTML('beforeend',item.html);
        
        const restoredSection = document.getElementById(id);
        restoredSection.querySelectorAll('.rich-editor').forEach(e => {
            e.addEventListener('keyup', () => updateToolbarState(e));
            e.addEventListener('mouseup', () => updateToolbarState(e));
            e.addEventListener('input', () => updateToolbarState(e)); // Added 'input' for better table/width update
        });
        restoredSection.querySelectorAll('.sec-url').forEach(e => {
            e.addEventListener('input', updateImagePreview);
            if (e.value) updateImagePreview({ target: e });
        });
        
        // Re-attach the onchange handler to the table width input
        restoredSection.querySelectorAll('[id^="tableWidthInput_"]').forEach(input => {
            input.onchange = function() { setTableWidth(this.value, this); };
        });

        const titleElement = restoredSection.querySelector('.section-title');
        if(titleElement) {
             titleElement.style.color = getComputedStyle(document.documentElement).getPropertyValue('--primary-accent');
        }

        refreshRestoreUI();
    }
}

// --- CLONE/DUPLICATE FUNCTIONALITY (Restored) ---

function cloneSectionDialog(button) {
    const section = button.closest('.section');
    const existingDropdown = section.querySelector('#cloneDropdown');
    
    if (existingDropdown) {
        existingDropdown.remove();
        return;
    }

    const dropdown = document.createElement('div');
    dropdown.id = 'cloneDropdown';
    dropdown.innerHTML = `
        <button onclick="cloneSection('${section.id}', 'above')">Clone Above</button>
        <button onclick="cloneSection('${section.id}', 'below')">Clone Below</button>
    `;
    button.insertAdjacentElement('afterend', dropdown);
}

function cloneSection(originalId, position) {
    const originalSection = document.getElementById(originalId);
    if (!originalSection) return;

    // Remove dropdown if it exists
    const dropdown = originalSection.querySelector('#cloneDropdown');
    if (dropdown) dropdown.remove();

    // 1. Create a deep clone
    const clonedSection = originalSection.cloneNode(true);
    
    // 2. Generate new ID
    const newId = originalId.split('_')[0] + '_' + Date.now();
    clonedSection.id = newId;
    
    // 3. Update title/config IDs (CRITICAL)
    const titleH3 = clonedSection.querySelector('.section-title');
    const defaultTitle = originalSection.dataset.defaultTitle + ' (Copy)';
    titleH3.innerText = defaultTitle;
    clonedSection.setAttribute('data-default-title', defaultTitle);

    // 4. Update internal IDs (e.g., table column count, color pickers, button containers)
    clonedSection.querySelectorAll('[id]').forEach(el => {
        if (el.id.includes(originalId.split('_')[1])) { // Target IDs based on original timestamp part
             el.id = el.id.replace(originalId, newId);
        } else if (el.id.includes('colCount_')) {
             el.id = el.id.replace(originalId, newId);
        } else if (el.id.includes('color_picker_')) {
             el.id = el.id.replace(originalId, newId);
        } else if (el.id.includes('tableWidthInput_')) { // NEW: Update table width input ID
             el.id = el.id.replace(originalId, newId);
             el.onchange = function() { setTableWidth(this.value, this); }; // Re-attach handler
        }
    });

    // 5. Clear rich-editor content but keep placeholder/attributes
    const originalEditor = originalSection.querySelector('.rich-editor');
    const clonedEditor = clonedSection.querySelector('.rich-editor');
    if (clonedEditor && originalEditor) {
        clonedEditor.innerHTML = originalEditor.innerHTML; // Keep content for a clone
        clonedEditor.addEventListener('keyup', () => updateToolbarState(clonedEditor));
        clonedEditor.addEventListener('mouseup', () => updateToolbarState(clonedEditor));
        clonedEditor.addEventListener('input', () => updateToolbarState(clonedEditor));
    }
    
    // 6. Fix table inputs - inputs need to have their values preserved
    clonedSection.querySelectorAll('input, textarea').forEach((clonedInput, index) => {
        const originalInput = originalSection.querySelectorAll('input, textarea')[index];
        if (originalInput) {
            clonedInput.value = originalInput.value;
            // Re-attach specific handlers for the new section
            if (clonedInput.getAttribute('onchange')?.includes('createTableFromConfig')) {
                clonedInput.onchange = () => createTableFromConfig(clonedInput);
            }
            if (clonedInput.classList.contains('sec-url')) {
                clonedInput.addEventListener('input', updateImagePreview);
            }
        }
    });

    // 7. Ensure correct action buttons on cloned custom table rows
    if (clonedSection.dataset.type === 'table') {
        clonedSection.querySelectorAll('tbody tr').forEach((row, index, list) => {
            const actionCell = row.querySelector('td:last-child');
            if (actionCell) {
                if (index === list.length - 1) {
                    actionCell.innerHTML = '<button class="btn add" onclick="addRow(this)">+</button>';
                } else {
                    actionCell.innerHTML = '<button class="btn remove" onclick="deleteRow(this)">-</button>';
                }
            }
        });
    }
    
    // 8. Insert the cloned section
    if (position === 'above') {
        originalSection.parentNode.insertBefore(clonedSection, originalSection);
    } else {
        originalSection.parentNode.insertBefore(clonedSection, originalSection.nextElementSibling);
    }
}

// --- SECTION ADDERS ---
let sectionCounter = 0;

function addRichTextSection(){
    sectionCounter++;
    const id = `sec_rich_${Date.now()}`;
    const defaultTitle = `Rich Content Section ${sectionCounter}`;
    const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-accent');
    const html = `
        <div class="section" id="${id}" data-default-title="${defaultTitle}" data-type="richtext">
            ${universalControlsHTML()}
            <h3 class="section-title" style="color: ${primaryColor};">${defaultTitle}</h3>
            ${richTextToolbarHTML(id)}
            <div class="rich-editor sec-content" contenteditable="true" data-placeholder="Enter content here..."></div>
        </div>
    `;
    document.getElementById('sectionsContainer').insertAdjacentHTML('beforeend', html);
    document.getElementById(id).querySelector('.rich-editor').addEventListener('keyup', (e) => updateToolbarState(e.target));
    document.getElementById(id).querySelector('.rich-editor').addEventListener('mouseup', (e) => updateToolbarState(e.target));
    document.getElementById(id).querySelector('.rich-editor').addEventListener('input', (e) => updateToolbarState(e.target));
}

function addCustomTable(){
    sectionCounter++;
    const id = `sec_table_${Date.now()}`;
    const defaultTitle = `Custom Table ${sectionCounter}`;
    const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-accent');
    const html = `
        <div class="section" id="${id}" data-default-title="${defaultTitle}" data-type="table">
            ${universalControlsHTML()}
            <h3 class="section-title" style="color: ${primaryColor};">${defaultTitle}</h3>
            <div class="table-config">
                <label for="colCount_${id}">Columns:</label>
                <input type="number" id="colCount_${id}" value="3" min="1" max="10" onchange="createTableFromConfig(this)">
            </div>
            <table>
                <thead>
                    <tr>
                        <th><input type="text" value="Header 1"></th>
                        <th><input type="text" value="Header 2"></th>
                        <th><input type="text" value="Header 3"></th>
                        <th style="width:90px">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="Data 1"></td>
                        <td><input type="text" placeholder="Data 2"></td>
                        <td><input type="text" placeholder="Data 3"></td>
                        <td><button class="btn add" onclick="addRow(this)">+</button></td>
                    </tr>
                </tbody>
            </table>
        </div>
    `;
    document.getElementById('sectionsContainer').insertAdjacentHTML('beforeend', html);
}

/**
 * FIX #3: Re-implementing a correct table column update logic.
 * @param {HTMLInputElement} input - The column count input element.
 */
function createTableFromConfig(input) {
    const section = input.closest('.section');
    const table = section.querySelector('table');
    const colCount = parseInt(input.value) || 1;
    const actualColCount = Math.max(1, Math.min(colCount, 10)); 

    // 1. Update Header (thead)
    const headerRow = table.querySelector('thead tr');
    // Store current header values
    let existingHeaderInputs = Array.from(headerRow.querySelectorAll('th:not(:last-child) input')).map(i => i.value);
    headerRow.innerHTML = '';
    
    for (let i = 0; i < actualColCount; i++) {
        const headerValue = existingHeaderInputs[i] || `Column ${i + 1}`;
        headerRow.insertAdjacentHTML('beforeend', `<th><input type="text" value="${headerValue}"></th>`);
    }
    // Add the Action column back
    headerRow.insertAdjacentHTML('beforeend', `<th style="width:90px">Action</th>`);


    // 2. Update Body (tbody) - Iterate ALL rows
    const tableBody = table.querySelector('tbody');
    const existingRows = Array.from(tableBody.querySelectorAll('tr'));
    
    existingRows.forEach((row, rowIndex) => {
        // Store current data cell values
        let existingCellInputs = Array.from(row.querySelectorAll('td:not(:last-child) input')).map(i => i.value);
        
        row.innerHTML = ''; // Clear the row content
        
        // Add data cells
        for (let i = 0; i < actualColCount; i++) {
            const cellValue = existingCellInputs[i] || '';
            const placeholder = `Data ${i + 1}`;
            row.insertAdjacentHTML('beforeend', `<td><input type="text" value="${cellValue}" placeholder="${placeholder}"></td>`);
        }

        // Add action cell (plus only on the last row, minus otherwise)
        const isLastRow = rowIndex === existingRows.length - 1;
        const actionButtonHTML = isLastRow && tableBody.childElementCount > 0 ? 
            `<button class="btn add" onclick="addRow(this)">+</button>` : 
            `<button class="btn remove" onclick="deleteRow(this)">-</button>`;
            
        row.insertAdjacentHTML('beforeend', `<td>${actionButtonHTML}</td>`);
    });
}


/**
 * FIX: Custom Table Add Row logic. Ensures the last row has '+' and others have '-'.
 * @param {HTMLButtonElement} button - The '+' button clicked.
 */
function addRow(button) {
    const tableBody = button.closest('tbody');
    const row = button.closest('tr');
    // CRITICAL: Get the number of columns from the THEAD to ensure consistency
    const colCount = row.closest('table').querySelector('thead tr').querySelectorAll('th').length - 1; 

    // 1. Change the '+' button on the current row to a '-' button
    const actionCell = row.querySelector('td:last-child');
    actionCell.innerHTML = '<button class="btn remove" onclick="deleteRow(this)">-</button>';
    
    // 2. Build the new row HTML
    let newRowHTML = '<tr>';
    // Use the column count to build the new row data cells
    for(let i = 0; i < colCount; i++) {
        newRowHTML += `<td><input type="text" placeholder="Data ${i+1}"></td>`;
    }
    // Add the action cell with the '+' button to the new row
    newRowHTML += `<td><button class="btn add" onclick="addRow(this)">+</button></td></tr>`;

    // 3. Insert the new row
    tableBody.insertAdjacentHTML('beforeend', newRowHTML);
    const newRowElement = tableBody.lastElementChild;
    newRowElement.querySelector('input').focus(); 
}

/**
 * FIX: Custom Table Delete Row logic. Ensures the new last row gets a '+' button if needed.
 * @param {HTMLButtonElement} button - The '-' button clicked.
 */
function deleteRow(button) {
    const row = button.closest('tr');
    const tableBody = row.closest('tbody');
    
    if (tableBody.childElementCount > 1) {
        const isLastRow = row === tableBody.lastElementChild;
        row.remove();

        if (isLastRow && tableBody.childElementCount > 0) {
            // If the row deleted was the last one, the new last row needs a '+' button
            const newLastRow = tableBody.lastElementChild;
            const actionCell = newLastRow.querySelector('td:last-child');
            // Ensure the new last row always has the ADD button
            if (actionCell && !actionCell.querySelector('.btn.add')) {
                actionCell.innerHTML = '<button class="btn add" onclick="addRow(this)">+</button>';
            }
        }
    } else {
        // If it's the only row, clear content instead of deleting
        row.querySelectorAll('input').forEach(input => input.value = '');
    }
}

function updateImagePreview(e) {
    const section = e.target.closest('.section');
    const url = e.target.value.trim();
    const container = section.querySelector('.image-container');
    container.innerHTML = '';

    if (url) {
        const img = document.createElement('img');
        img.src = url;
        img.alt = section.querySelector('.sec-caption').value || 'Image preview';
        img.onerror = function() {
            this.src = `https://placehold.co/600x400/FF5733/ffffff?text=Image+Load+Failed`;
        };
        container.appendChild(img);
    }
}

function addImageSection(){
    sectionCounter++;
    const id = `sec_image_${Date.now()}`;
    const defaultTitle = `Image/Media ${sectionCounter}`;
    const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-accent');
    const html = `
        <div class="section" id="${id}" data-default-title="${defaultTitle}" data-type="image">
            ${universalControlsHTML()}
            <h3 class="section-title" style="color: ${primaryColor};">${defaultTitle}</h3>
            <input type="url" class="sec-url" placeholder="Enter Image URL (e.g. https://...)" oninput="updateImagePreview(event)">
            <textarea class="sec-caption" placeholder="Enter image caption/alt text..."></textarea>
            <div class="image-container" style="max-width: 500px; margin: 10px auto; border: 1px dashed #ccc; padding: 10px; text-align: center;"></div>
            <div class="small" style="margin-top:10px">Preview will show after entering a valid URL.</div>
        </div>
    `;
    document.getElementById('sectionsContainer').insertAdjacentHTML('beforeend', html);
}

function addSimpleTextSection(){
    sectionCounter++;
    const id = `sec_simple_${Date.now()}`;
    const defaultTitle = `Simple Text Block ${sectionCounter}`;
    const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-accent');
    const html = `
        <div class="section" id="${id}" data-default-title="${defaultTitle}" data-type="simpletext">
            ${universalControlsHTML()}
            <h3 class="section-title" style="color: ${primaryColor};">${defaultTitle}</h3>
            <textarea class="sec-content" placeholder="Enter simple text... No formatting."></textarea>
        </div>
    `;
    document.getElementById('sectionsContainer').insertAdjacentHTML('beforeend', html);
}

function addActionButtonSection(){
    sectionCounter++;
    const id = `sec_buttons_${Date.now()}`;
    const defaultTitle = `Action Buttons ${sectionCounter}`;
    const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-accent');
    const containerId = `actionButtonsContainer_${id}`;
    const html = `
        <div class="section" id="${id}" data-default-title="${defaultTitle}" data-type="buttons">
            ${universalControlsHTML()}
            <h3 class="section-title" style="color: ${primaryColor};">${defaultTitle}</h3>
            <div id="${containerId}" style="margin-top: 15px;"></div>
            <div style="margin-top:8px">
                <button class="btn add" onclick="addActionButton('Apply Now', '#', '${containerId}')">+ Add Button</button>
            </div>
            <div class="small">Buttons with custom labels, links, and colors (Renders with H2 heading).</div>
        </div>
    `;
    document.getElementById('sectionsContainer').insertAdjacentHTML('beforeend', html);
    addActionButton('Apply Now', '#', containerId);
}

function addNoHeadingButtonsSection(){
    sectionCounter++;
    const id = `sec_nohead_buttons_${Date.now()}`;
    const defaultTitle = `Action Buttons (No Post Heading) ${sectionCounter}`;
    const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-accent');
    const containerId = `noHeadingButtonsContainer_${id}`;
    const html = `
        <div class="section" id="${id}" data-default-title="${defaultTitle}" data-type="noheadingbuttons">
            ${universalControlsHTML()}
            <h3 class="section-title" style="color: ${primaryColor};">${defaultTitle}</h3>
            <div id="${containerId}" style="margin-top: 15px;"></div>
            <div style="margin-top:8px">
                <button class="btn add" onclick="addActionButton('Read More', '#', '${containerId}')">+ Add Button</button>
            </div>
            <div class="small">Renders buttons without an H2 heading in the post.</div>
        </div>
    `;
    document.getElementById('sectionsContainer').insertAdjacentHTML('beforeend', html);
    addActionButton('Read More', '#', containerId);
}

function addTextLinkSection(){
    sectionCounter++;
    const id = `sec_links_${Date.now()}`;
    const defaultTitle = `Text Links (No Post Title)`;
    const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-accent');
    const containerId = `textLinksContainer_${id}`;
    const html = `
        <div class="section" id="${id}" data-default-title="${defaultTitle}" data-type="textlinks">
            ${universalControlsHTML()}
            <h3 class="section-title" style="color: ${primaryColor};">${defaultTitle}</h3>
            <div class="text-link-container" id="${containerId}" style="margin-top: 15px;"></div>
            <div style="margin-top:8px">
                <button class="btn add" onclick="addActionButton('Official Website', 'https://www.example.org', '${containerId}')">+ Add Text Link</button>
            </div>
            <div class="small">List of clickable text links with custom colors (No section heading in post)</div>
        </div>
    `;
    document.getElementById('sectionsContainer').insertAdjacentHTML('beforeend', html);
    addActionButton('Official Website', 'https://www.example.org', containerId);
}

function addActionButton(defaultLabel = 'Apply Now', defaultUrl = '#', containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    const id = Date.now() + Math.floor(Math.random() * 1000); 
    const newButtonRow = document.createElement('div');
    newButtonRow.id = `btn_row_${id}`;
    
    if (container.classList.contains('text-link-container')) {
        newButtonRow.innerHTML = `
            <div class="btn-controls">
                <button class="btn updown" onclick="moveActionButton(this, 'up')">↑</button>
                <button class="btn updown" onclick="moveActionButton(this, 'down')">↓</button>
            </div>
            <input type="text" class="link-label" value="${defaultLabel}" placeholder="Link Text" style="width: 150px;">
            <input type="url" class="link-url" value="${defaultUrl}" placeholder="Link URL" style="flex-grow: 1;">
            <label style="font-size:13px;">Text:</label>
            <input type="color" class="link-color" value="#007bff" title="Link Color">
            <label style="font-size:13px;">Hover:</label>
            <input type="color" class="link-hover-color" value="#0056b3" title="Hover Color">
            <button class="btn remove" onclick="deleteActionButton(this)">Remove</button>
        `;
    } else {
        newButtonRow.innerHTML = `
            <div class="btn-controls">
                <button class="btn updown" onclick="moveActionButton(this, 'up')">↑</button>
                <button class="btn updown" onclick="moveActionButton(this, 'down')">↓</button>
            </div>
            <input type="text" class="btn-label" value="${defaultLabel}" placeholder="Button Label" style="width: 180px;">
            <input type="url" class="btn-url" value="${defaultUrl}" placeholder="Link URL" style="flex-grow: 1;">
            <label style="font-size:13px;">Btn:</label>
            <input type="color" class="btn-color" value="#dc3545" title="Button Color">
            <label style="font-size:13px;">Hover:</label>
            <input type="color" class="btn-hover-color" value="#c82333" title="Hover Color">
            <button class="btn remove" onclick="deleteActionButton(this)">Remove</button>
        `;
    }
    
    container.appendChild(newButtonRow);
}

function deleteActionButton(button) {
    button.closest('div').remove();
}

function moveActionButton(button, direction) {
    const row = button.closest('div');
    const container = row.parentNode;
    
    if (direction === 'up' && row.previousElementSibling) {
        container.insertBefore(row, row.previousElementSibling);
    } else if (direction === 'down' && row.nextElementSibling) {
        container.insertBefore(row.nextElementSibling, row);
    }
}

// Function to generate the HTML for the post content inside the preview container
function generatePostContent(isDownload = false) {
    const primaryColor = document.getElementById('primaryColorPicker').value;
    const secondaryColor = document.getElementById('secondaryColorPicker').value;
    const sectionsContainer = document.getElementById('sectionsContainer');
    let postTitle = document.getElementById('postTitle').value.trim() || 'Untitled Post - Govt Job Notification';
    
    let previewContent = '';
    let dynamicStyles = '';

    // 1. New Blue Header
    previewContent += UNIVERSAL_TOP_HEADER(primaryColor);

    // 2. Post Container
    previewContent += `<div class="post-container" style="background-color: #ffffff; max-width: 1200px; margin: 0 auto; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">`;

    // 3. Post Title Box
    previewContent += `
        <div class="post-header-box" style="text-align: center; margin-top: 30px; margin-bottom: 30px; padding: 20px; background-color: ${primaryColor}; color: white; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
            <h1 style="font-size: 2.2em; margin: 0 0 10px 0; color: white;">
                <strong>${postTitle}</strong>
            </h1>
            <p style="font-size: 1.1em; opacity: 0.9; margin: 0;">Latest Update from RozgarDesk.in</p>
        </div>
    `;

    sectionsContainer.querySelectorAll('.section').forEach(section => {
        const sectionType = section.dataset.type;
        let title = section.querySelector('.section-title').innerText;
        let contentHTML = '';
        let hasContent = false;

        // Rich Text
        if (sectionType === 'richtext') {
            const content = section.querySelector('.rich-editor').innerHTML.trim();
            if (content) {
                hasContent = true;
                contentHTML = `
                    <div class="themed-section" style="border-left: 5px solid ${primaryColor}; background-color: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); margin-bottom: 25px;">
                        <h3 style="color:${primaryColor}; font-size:22px; margin-top:0;">${title}</h3>
                        <div class="section-body">${content}</div>
                    </div>
                `;
            }
        } 
        // Simple Text
        else if (sectionType === 'simpletext') {
            const content = section.querySelector('.sec-content').value.trim().replace(/\n/g, '<br>');
            if (content) {
                hasContent = true;
                contentHTML = `
                    <div class="themed-section" style="border-left: 5px solid ${primaryColor}; background-color: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); margin-bottom: 25px;">
                        <h3 style="color:${primaryColor}; font-size:22px; margin-top:0;">${title}</h3>
                        <p>${content}</p>
                    </div>
                `;
            }
        } 
        // Image
        else if (sectionType === 'image') {
            const url = section.querySelector('.sec-url').value.trim();
            const caption = section.querySelector('.sec-caption').value.trim();
            if (url) {
                hasContent = true;
                contentHTML = `
                    <div class="themed-section" style="border-left: 5px solid ${primaryColor}; background-color: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); margin-bottom: 25px;">
                        <h3 style="color:${primaryColor}; font-size:22px; margin-top:0;">${title}</h3>
                        <div class="image-container" style="text-align:center;">
                            <img src="${url}" alt="${caption}" style="max-width:100%; height:auto; border-radius:6px; margin-top:8px;">
                            ${caption ? `<p style="font-style:italic; font-size:14px; color:#666; margin-top:8px;">${caption}</p>` : ''}
                        </div>
                    </div>
                `;
            }
        } 
        // Table (The dedicated "Custom Table" section)
        else if (sectionType === 'table') {
            const table = section.querySelector('table');
            const dataColumnsCount = table.querySelector('thead tr').querySelectorAll('th').length - 1;
            let tableHTML = '<table>';
            
            // Table Header
            const headerRow = table.querySelector('thead tr');
            tableHTML += '<thead><tr>';
            headerRow.querySelectorAll('th').forEach((th, index) => {
                if (index < dataColumnsCount) { 
                    const headerText = th.querySelector('input') ? th.querySelector('input').value.trim() : th.innerText.trim();
                    tableHTML += `<th>${headerText}</th>`;
                }
            });
            tableHTML += '</tr></thead>';

            // Table Body
            tableHTML += '<tbody>';
            let tableHasContent = false;
            table.querySelectorAll('tbody tr').forEach(row => {
                let rowData = [];
                let rowHasContent = false;
                
                for(let i = 0; i < dataColumnsCount; i++) {
                    const td = row.querySelectorAll('td')[i];
                    if (td) {
                        const cellContent = td.querySelector('input') ? td.querySelector('input').value.trim() : td.innerText.trim();
                        rowData.push(`<td>${cellContent}</td>`);
                        if (cellContent !== '') {
                            rowHasContent = true;
                        }
                    }
                }
                
                if (rowHasContent) {
                     tableHTML += `<tr>${rowData.join('')}</tr>`;
                     tableHasContent = true;
                }
            });
            tableHTML += '</tbody></table>';

            if (tableHasContent) {
                hasContent = true;
                contentHTML = `
                    <div style="margin-bottom: 25px;">
                        <h2 style="color: ${primaryColor}; border-bottom: 3px solid ${primaryColor}; padding-bottom: 10px; margin-top: 40px; margin-bottom: 16px; font-size: 26px; font-weight: 600;">${title}</h2>
                        ${tableHTML}
                    </div>
                `;
            }
        } 
        // Action Buttons
        else if (sectionType === 'buttons' || sectionType === 'noheadingbuttons') {
            const buttonContainer = section.querySelector('[id^="actionButtonsContainer"], [id^="noHeadingButtonsContainer"]');
            const buttonRows = buttonContainer ? buttonContainer.querySelectorAll('div') : [];
            let buttonLinks = [];
            buttonRows.forEach((row, index) => {
                const label = row.querySelector('.btn-label')?.value.trim();
                const url = row.querySelector('.btn-url')?.value.trim();
                const color = row.querySelector('.btn-color')?.value.trim();
                const hoverColor = row.querySelector('.btn-hover-color')?.value.trim();
                if (label && url && color && hoverColor) {
                    buttonLinks.push({ label, url, color, hoverColor, index });
                }
            });
            
            if (buttonLinks.length > 0) {
                hasContent = true;
                const styleId = `btn_styles_${section.id}`;
                let styleTag = `<style type="text/css" id="${styleId}">`;
                
                const buttonsHtml = buttonLinks.map((b, index) => {
                    const className = `apply-button-${section.id}-${index}`;
                    styleTag += `
                        .${className} { background: ${b.color} !important; }
                        .${className}:hover { background: ${b.hoverColor} !important; }
                    `;
                    return `<a href="${b.url}" target="_blank" class="${className}" style="display: inline-block; color: #fff; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 700; margin: 8px; font-size: 16px; transition: all 0.2s;">${b.label}</a>`;
                }).join('');
                
                styleTag += `</style>`;
                dynamicStyles += styleTag;

                const headingHtml = sectionType === 'buttons' ? 
                    `<h2 style="color: ${primaryColor}; border-bottom: 3px solid ${primaryColor}; padding-bottom: 10px; margin-top: 40px; margin-bottom: 16px; font-size: 26px; font-weight: 600;">${title}</h2>` : '';
                
                contentHTML = `
                    <div style="margin-bottom: 25px;">
                        ${headingHtml}
                        <div class="action-button-group" style="text-align: center; margin: 20px 0 10px 0; padding: 15px; background-color: #f8f9fa; border: 1px solid #eee; border-radius: 8px;">
                            ${buttonsHtml}
                        </div>
                    </div>
                `;
            }
        } 
        // Text Links
        else if (sectionType === 'textlinks') {
            const linkContainer = section.querySelector('[id^="textLinksContainer"]');
            const linkRows = linkContainer ? linkContainer.querySelectorAll('div') : [];
            let textLinks = [];
            linkRows.forEach((row, index) => {
                const label = row.querySelector('.link-label')?.value.trim();
                const url = row.querySelector('.link-url')?.value.trim();
                const color = row.querySelector('.link-color')?.value.trim();
                const hoverColor = row.querySelector('.link-hover-color')?.value.trim();
                if (label && url && color && hoverColor) {
                    textLinks.push({ label, url, color, hoverColor, index });
                }
            });

            if (textLinks.length > 0) {
                hasContent = true;
                const styleId = `link_styles_${section.id}`;
                let styleTag = `<style type="text/css" id="${styleId}">`;
                
                const linksHtml = textLinks.map(l => {
                    const className = `text-link-${section.id}-${l.index}`;
                    styleTag += `
                        .${className} { color: ${l.color} !important; }
                        .${className}:hover { color: ${l.hoverColor} !important; text-decoration: underline; }
                    `;
                    return `<p style="margin: 8px 0;"><a href="${l.url}" target="_blank" class="${className}" style="text-decoration: none;"><strong>${l.label}</strong></a></p>`;
                }).join('');
                
                styleTag += `</style>`;
                dynamicStyles += styleTag;

                contentHTML = `
                    <div class="text-link-group" style="text-align: left; margin: 20px 0; padding: 15px; background-color: #f8f9fa; border: 1px solid #eee; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 25px;">
                        ${linksHtml}
                    </div>
                `;
            }
        }

        previewContent += contentHTML;
    });

    previewContent += `</div>`; // Close post-container

    if (!isDownload && previewContent.length < 500) { 
        return `
            ${UNIVERSAL_TOP_HEADER(primaryColor)}
            <div style="text-align: center; padding: 50px; background: #fff; border: 1px dashed #ccc; border-radius: 8px; max-width: 1200px; margin: 20px auto;">
                <h3 style="color:#dc3545;">No content generated yet.</h3>
                <p>Add some sections above and click 'Preview' again!</p>
            </div>
        `;
    }

    previewContent += UNIVERSAL_FOOTER;

    if (isDownload) {
        return { postContent: previewContent, dynamicStyles: dynamicStyles };
    } else {
        return dynamicStyles + previewContent;
    }
}


function previewPost() {
    const previewDiv = document.getElementById('preview');
    const result = generatePostContent(false);
    
    if (typeof result === 'string' && result.includes('No content generated yet.')) {
        previewDiv.innerHTML = result;
    } else {
        previewDiv.innerHTML = result;
    }

    if (previewDiv.classList.contains('hidden')) {
        previewDiv.classList.remove('hidden');
        previewDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

function downloadHTML() {
    const postTitle = document.getElementById('postTitle').value.trim() || 'untitled-post';
    const primaryColor = document.getElementById('primaryColorPicker').value;
    const secondaryColor = document.getElementById('secondaryColorPicker').value;
    
    const { postContent, dynamicStyles } = generatePostContent(true);

    const minimalCSS = `
    <style>
        :root {
            --primary-accent: ${primaryColor};
            --secondary-accent: ${secondaryColor};
            --danger: #dc3545;
        }
        body { font-family: Arial, sans-serif; background-color: #f8f9fa; line-height: 1.7; color: #333; padding: 0; margin: 0; }
        .post-container { max-width: 1200px; margin: 0 auto; background-color: #ffffff; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        header {background-color:var(--primary-accent); max-width: 1200px; margin: 0 auto; padding:12px 20px; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;}
        header a {color:white !important; text-decoration:none !important; font-size:22px !important; font-weight:700 !important;}

        .post-header-box { text-align: center; margin-top: 30px; margin-bottom: 30px; padding: 20px; background-color: var(--primary-accent); color: white; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .post-header-box h1 { font-size: 2.2em; margin: 0 0 10px 0; color: white; }
        
        .themed-section { background-color: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); border-left: 5px solid var(--primary-accent); margin-bottom: 25px; }
        .themed-section h3 { color: var(--primary-accent); margin-top: 0; }
        
        h1{font-size:32px;margin:20px 0 14px 0;font-weight:700;color:#1a1a1a} 
        h2 { color: var(--primary-accent); border-bottom: 3px solid var(--primary-accent); padding-bottom: 10px; margin-top: 40px; margin-bottom: 16px; font-size: 26px; font-weight: 600; } 
        h3 { color: var(--secondary-accent); font-size: 22px; margin: 16px 0 8px 0; font-weight: 600; } 
        h4 { color: #333; font-size: 18px; margin: 14px 0 6px 0; font-weight: 600; } 

        p, ul, ol, li, .section-body { line-height: 1.7; color: #333; }
        ul, ol { padding-left: 20px; margin: 10px 0; }
        li { margin-bottom: 8px; }
        
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: middle; }
        th { background: #e9f5ff; font-weight: 700; color: var(--primary-accent); border-top: 3px solid var(--primary-accent); }
        
        /* Pasted Table CSS for Preview (to match Rich Editor Style) */
        .section-body table {
            width: auto; 
            border: 1px solid #ddd;
            margin: 15px 0;
            border-collapse: collapse;
            max-width: 100%; 
        }
        .section-body table th, .section-body table td {
             border: 1px solid #ddd; 
             padding: 8px 10px;
        }
        .section-body table th {
            background: #e9f5ff; 
            font-weight: 700;
            color: var(--primary-accent);
        }
        .section-body table[align="center"] {
            margin-left: auto;
            margin-right: auto;
        }
        .section-body table[align="right"] {
            margin-left: auto;
            margin-right: 0;
        }
        .section-body table[align="left"] {
            margin-left: 0;
            margin-right: auto;
        }

        .action-button-group { text-align: center; margin: 20px 0 10px 0; padding: 15px; background-color: #f8f9fa; border: 1px solid #eee; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .apply-button { display: inline-block; color: #fff; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 700; margin: 8px; font-size: 16px; transition: all 0.2s; }

        .text-link-group { text-align: left; margin: 20px 0; padding: 15px; background-color: #f8f9fa; border: 1px solid #eee; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .text-link-group p { margin: 8px 0; }

        .image-container img { max-width: 100%; height: auto; border-radius: 6px; margin-top: 8px; }

        a { color: var(--primary-accent); text-decoration: none; }
        a:hover { text-decoration: underline; }

        footer {all: initial; display: block; width: 100%; text-align: center; padding: 15px 10px; background-color: #2c3e50; color: #ffffff; font-family: Arial, Helvetica, sans-serif; font-size: 14px; box-sizing: border-box; max-width: 1200px; margin: 0 auto; border-top-left-radius: 8px; border-top-right-radius: 8px; }
        footer p {all: unset; display: inline; color: #ffffff;}
        footer a {all: unset; color:#ffffff; cursor:pointer; text-decoration:none; font-weight:500;}
        footer a:hover { text-decoration: underline; }
    </style>`;

    const fullHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${postTitle}</title>
    ${minimalCSS}
    ${dynamicStyles}
</head>
<body>
    ${postContent}
</body>
</html>
    `;

    const blob = new Blob([fullHTML], { type: 'text/html' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${postTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
}


// --- INITIALIZATION & EVENT HANDLERS ---
(function init(){
    let buttonsContainer = document.getElementById('actionButtonsContainer');
    if (buttonsContainer && buttonsContainer.children.length === 0) {
        addActionButton('Click Here to Apply Online','https://example.com/apply', 'actionButtonsContainer');
    }
    
    document.querySelectorAll('.rich-editor').forEach(e => {
        e.addEventListener('keyup', () => updateToolbarState(e));
        e.addEventListener('mouseup', () => updateToolbarState(e));
        e.addEventListener('input', () => updateToolbarState(e)); // Added 'input'
    });
    
    // CRITICAL FIX: MODIFIED Paste Handler to allow table HTML and clean it properly
    document.addEventListener('paste',function(e){
        const t=e.target;
        if(t.classList && t.classList.contains('rich-editor')){
            e.preventDefault();
            const h=e.clipboardData.getData('text/html');
            const tx=e.clipboardData.getData('text/plain');
            
            if(h){
                const tm=document.createElement('div');
                tm.innerHTML=h;
                
                // Deep Cleanup: Aggressively strip scripts and styles for safety
                tm.querySelectorAll('*').forEach(el => {
                    if(el.tagName === 'STYLE' || el.tagName === 'SCRIPT') { el.remove(); }
                    // Only remove inline styles, keep classes if they contain formatting 
                    // (Though for max safety, removing all attributes like before is best, but prevents table styling)
                    el.removeAttribute('style'); 
                });
                
                // Ensure tables get basic structure and width property
                tm.querySelectorAll('table').forEach(table => {
                    if (!table.hasAttribute('align')) {
                        table.setAttribute('align', 'left'); 
                    }
                    if (!table.style.width) {
                        table.style.width = '100%'; 
                    }
                });

                document.execCommand('insertHTML',false,tm.innerHTML);
                
            } else {
                document.execCommand('insertText',false,tx);
            }
        }
    });

    // Close clone dropdown on outside click:
    document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('cloneDropdown');
        const cloneButton = document.querySelector('[onclick*="cloneSectionDialog"]'); 
        
        if (dropdown && !dropdown.contains(e.target) && e.target !== cloneButton && !e.target.closest('[onclick*="cloneSectionDialog"]')) {
            dropdown.remove();
        }
    });
    
    updateCustomColors();

})();
</script>
</body>
</html>